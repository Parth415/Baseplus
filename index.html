// Replace with your Supabase credentials
const SUPABASE_URL = 'https://zioghqkcduxbemqzrrpj.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inppb2docWtjZHV4YmVtcXpycnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MzI4MzAsImV4cCI6MjA2OTUwODgzMH0.2gUMAZLPmhh81JBihLmWh6jMNS-GTtcYxlV-h-JtahI'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Load real signup count on page load
async function loadSignupCount() {
    try {
        const { count, error } = await supabase
            .from('base_plus_signups')
            .select('*', { count: 'exact', head: true })
        
        if (error) throw error
        
        const target = count || 2847
        animateCounterTo(target)
    } catch (error) {
        console.log('Using fallback count:', error)
        animateCounterTo(2847)
    }
}

// Enhanced counter animation to specific number
function animateCounterTo(target) {
    const counter = document.getElementById('memberCount');
    const duration = 2000;
    const increment = target / (duration / 16);
    let current = 0;
    
    const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
            current = target;
            clearInterval(timer);
        }
        counter.textContent = Math.floor(current).toLocaleString();
    }, 16);
}

// Form submission with Supabase
document.getElementById('waitingListForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');
    const form = document.getElementById('waitingListForm');
    
    // Enhanced loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Joining the Squad... ðŸŒŸ';
    submitBtn.style.background = 'linear-gradient(135deg, #a0aec0, #718096)';
    
    // Collect form data
    const formData = new FormData(form);
    const data = {
        first_name: formData.get('firstName'),
        last_name: formData.get('lastName'),
        email: formData.get('email').toLowerCase().trim(),
        age_range: formData.get('age'),
        interest: formData.get('interest'),
        flavor_preference: formData.get('flavor'),
        referral_source: formData.get('referral'),
        comments: formData.get('comments'),
        newsletter_opt_in: formData.has('newsletter')
    };
    
    try {
        // Insert into Supabase
        const { error } = await supabase
            .from('base_plus_signups')
            .insert([data])
        
        if (error) {
            if (error.code === '23505') { // Unique constraint violation
                throw new Error('This email is already on the waitlist! ðŸŽ‰')
            }
            throw error
        }
        
        // Success! Hide form and show success message
        form.style.transform = 'translateY(-20px)';
        form.style.opacity = '0';
        
        setTimeout(async () => {
            form.style.display = 'none';
            successMessage.style.display = 'block';
            
            // Update counter with real count
            const { count } = await supabase
                .from('base_plus_signups')
                .select('*', { count: 'exact', head: true })
            
            if (count) {
                const counter = document.getElementById('memberCount');
                counter.textContent = count.toLocaleString();
            }
        }, 300);
        
    } catch (error) {
        console.error('Signup error:', error);
        alert('Oops! ' + (error.message || 'Something went wrong. Please try again.'));
        
        // Reset button
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Secure My Spot ðŸš€';
        submitBtn.style.background = 'linear-gradient(135deg, #ff6b6b, #4ecdc4)';
    }
});

// Enhanced interactions
document.querySelectorAll('input, select, textarea').forEach(input => {
    input.addEventListener('focus', function() {
        this.parentElement.style.transform = 'scale(1.02)';
        this.parentElement.style.transition = 'transform 0.2s ease';
    });
    
    input.addEventListener('blur', function() {
        this.parentElement.style.transform = 'scale(1)';
    });
});

// Initialize animations
window.addEventListener('load', () => {
    loadSignupCount();
    
    // Stagger form field animations
    const formGroups = document.querySelectorAll('.form-group, .checkbox-wrapper');
    formGroups.forEach((group, index) => {
        group.style.opacity = '0';
        group.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            group.style.transition = 'all 0.4s ease';
            group.style.opacity = '1';
            group.style.transform = 'translateY(0)';
        }, index * 100);
    });
});

// Add some fun easter eggs
let clickCount = 0;
document.querySelector('.logo').addEventListener('click', () => {
    clickCount++;
    if (clickCount === 5) {
        document.body.style.animation = 'gradientShift 2s ease infinite';
        setTimeout(() => {
            document.body.style.animation = 'gradientShift 15s ease infinite';
        }, 4000);
    }
});
